{% extends "layout.html" %}
{% block body %}
<div class="container-fluid">
	<h3>Sample: {{sample_name}}</h3>

	<div id="sample-graph"></div>
  <div id="chromosome-graph"></div>
  <div id="sample-table"></div>
</div>

<script type="text/javascript">
var events = {{ events|tojson|safe }};
var chromosome_sizes = {{ chromosome_sizes|tojson|safe }};

var table_headers = ['type', 'description', 'id', 'breakend locations'];

var end_locations = _.flatten(_.map(events, 
    function(event, i) { return event['breakend locations array'] })); 

var ends_grouped_by_chromosome = _.groupBy(end_locations, 'chrom'); 
var chromosome_counts = _.map(ends_grouped_by_chromosome, 'length');
var chromosome_breakrate = _.mapObject(ends_grouped_by_chromosome, function(value, key) {
  var ucsc_chrom = value[0]['ucsc_chrom'];
  var chrom_size = chromosome_sizes[ucsc_chrom];
  return value.length / chrom_size * 1000000;
});
var chromosome_names = _.keys(ends_grouped_by_chromosome);

var columns = ['Breakends in region', 'Breakrate']; // TODO dry this
var y_labels =  ['Number of Breakends', 'Breakends per Mb'];
var hidden_column = 'Breakends in region';

// Generate sample chart *************************************************

var chart_height = 200;

// Make chart
var chart_json = {
  onrendered: function(e) {
    // Link legend selections to chart column switches *******************
    $('#sample-graph .c3-legend-item').on('click', function(e) {
      var shown_fields = _.pluck(chart.data.shown(), 'id');
      var name = e.currentTarget.__data__;
      if (shown_fields.length > 1 && _.contains(shown_fields, name)) { // Hide other fields (chart.hide works poorly fyi, so i'm regenerating the chart)
        chart_json.data.hide = _.without(columns, name);
        chart_json.axis.y.label.text = y_labels[columns.indexOf(name)];
        chart.destroy();
        chart = c3.generate(chart_json);
      }
    });

  },
  size: {
    height: chart_height
  },
  bindto: '#sample-graph',
  data: {
      hide: [hidden_column],
      columns: [
        ['Breakends in region'].concat(chromosome_counts),
        ['Breakrate'].concat(_.values(chromosome_breakrate)) // TODO dry this
      ],
      type: 'bar',
      selection: {
        enabled: true,
        draggable: true
      },
      onmouseover: function(d, element) {
        // Generate chromsome chart for given chromosome
        console.log(d, element);
        var chromosome = chromosome_names[d.index].toString();
        var ends_on_chromosome = ends_grouped_by_chromosome[chromosome];

        var ucsc_chrom = ends_on_chromosome[0]['ucsc_chrom'];
        var chrom_size = chromosome_sizes[ucsc_chrom];

        var x = d3.scale.linear()
          .domain([0, chrom_size]);

        // Generate a histogram using twenty uniformly-spaced bins.
        var binned_positions = d3.layout.histogram()
          .bins(x.ticks(50))
          (_.pluck(ends_on_chromosome, 'pos'));

        console.log(binned_positions)

        console.log(chrom_size);
        chrom_chart_json = {
          size: {
            height: chart_height
          },
          bindto: '#chromosome-graph',
          data: {
            columns: [['Breakends in region'].concat(_.map(binned_positions,'length'))],
            type: 'bar'
          },
          legend: {
            show: false
          },
          axis: {
            y: {
              label: {
                text: 'Breakends in region on ' + chromosome,
                position: 'outer-right'
              },
              tick: {
                format: d3.format("d")
              }
            }
          }

        };
        chrom_chart = c3.generate(chrom_chart_json);

      },
      onselected: function (d, element) {
        var chromosome = chromosome_names[d.index].toString();
        var ends_on_chromsome = ends_grouped_by_chromosome[chromosome];
        var corresponding_event_objects = _.unique(_.flatten(
          _.map(ends_on_chromsome, function(end) { 
            return _.filter(events, function(event) { 
              return event['id'] == end["sv_id"]; 
            })
        }))); // TODO dry this 

        $('#sample-table table').bootstrapTable(
          (chart.selected().length == 1) ? 'load' : 'prepend', 
          corresponding_event_objects);    
        row_listening();  
      },
      onunselected: function (d, element) {
        var chromosome = chromosome_names[d.index].toString();
        var ends_on_chromsome = ends_grouped_by_chromosome[chromosome];
        var corresponding_event_objects = _.unique(_.flatten(
          _.map(ends_on_chromsome, function(end) { 
            return _.filter(events, function(event) { 
              return event['id'] == end["sv_id"]; 
            })
        }))); // TODO dry this 

        if (chart.selected() == 0) {
          $('#sample-table table').bootstrapTable('load', events);
        } else {
          _.each(corresponding_event_objects, function(event_obj) {
            $('#sample-table table').bootstrapTable('remove', {field: 'id', values: [event_obj.id.toString()]})
          });
        }
        row_listening();
      }
  },
  axis: {
    x: {
      type: 'category',
      categories: chromosome_names,
      tick: {
        multiline: true,
        centered: true
      },
      label: {
        text: 'Chromosome',
        position: 'outer-left'
      }
    },
    y: {
      tick: {
        // format: d3.format("d")
      },
      label: {
        //text: 'Number of Breakends',
        text: 'Breakends per Mb',
        position: 'outer-right'
      }
    }
  },
  legend: {
    show: true
  }
};

var chart = c3.generate(chart_json);

// Generate sample table *************************************************

// Add table
var table = d3.select('#sample-table')
  .append('table')
    .classed('table-no-bordered', true)
    .attr('data-toggle', 'table')
    .attr('data-show-columns', false)
    .attr('data-search', false)
    .attr('data-id-field', 'name')
    .attr('data-sort-name', 'name')
    .attr('data-sort-order', 'asc')
    .attr('data-click-to-select', true)
    .attr('data-maintain-selected', false)
    .attr('data-filter-control', true)
    .attr('data-show-refresh', false);

table
  .append('thead').append('tr').selectAll('th')
    .data(table_headers).enter()
  .append('th') // Add column headings
    .text(function (header) { return header; })
    .attr('data-field', function (header) { return header; })
    .attr('data-sortable', true)
    .attr('data-filter-control', 'input');    

table
  .append('tbody');

// Populate table with cohort data
$(table).bootstrapTable({data: events});

// Add data binding so D3 methods can be used on the table
table.selectAll('tbody tr').data(events).enter();


// Event handlers ********************************************************

// Update chart order on search ******************************************

$('#sample-table').on('column-search.bs.table', function() { // TODO really slow
  var updated_events = $('#sample-table table').bootstrapTable('getData');

  end_locations = _.flatten(_.map(updated_events, 
      function(event, i) { return event['breakend locations array'] })); 

  ends_grouped_by_chromosome = _.groupBy(end_locations, 'chrom'); 
  chromosome_counts = _.map(ends_grouped_by_chromosome, 'length');
  chromosome_names = _.keys(ends_grouped_by_chromosome);

  chart_json.data.columns = [['breakends in region'].concat(_.values(chromosome_counts))];
  chart_json.axis.x.categories = chromosome_names;

  chart.destroy();
  chart = c3.generate(chart_json);
  row_listening();
});

// Link to SV profile on row click ***************************************

$('#sample-table').on('click-row.bs.table', function(e, d) {
  window.location.href = '/sample:'.concat({{ sample_name|tojson|safe }}).concat('/event:').concat(d.vcf_id);
});

// Make rows look more like links on hover *******************************
var row_listening = function() {
  d3.selectAll('#sample-table table tbody tr')
    .on('mouseover', function(d, i) { d3.select(this).classed('link', true); })
    .on('mouseout', function(d, i) { d3.select(this).classed('link', false); });
};
row_listening();

// Bootstrap Table debugging helper **************************************

/*$('#sample-table').on('all.bs.table', function(e, d) {
  console.log(e, d);
});*/





</script>
{% endblock %}