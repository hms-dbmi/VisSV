{% extends "layout.html" %}
{% block body %}
<div class="container">
	<h3>Sample: {{sample_name}}</h3>
	<h4>SV: {{event_id}}</h4>
	<br>
	<table class="table table-hover" id="breakend-list">
		<thead><tr>
		{% for attr in attrs_to_show %}
			<th>{{ attr }}</th>
		{% endfor %}
		</tr></thead>
		<tbody></tbody>
	</table>

  <div id="breakend-viz">
    <h4>Structure View</h4>
  </div>
  
  <div id="gene-list"></div>  	
</div>

<script type="text/javascript">
var event_type = {{ event_type|tojson|safe }};
var arrangement = {{ arrangement|tojson|safe }};
var viz_range = 1000; // in bp
var bp_scale = 20; // bp/pix
var end_separation = 50;

var breakends = {{ breakends|tojson|safe }};
var columns = {{ attrs_to_show|tojson|safe }};
var selected_breakend = breakends[0];
var gene_range = 100000; // in bp

var viz = d3.select("#breakend-viz").append("svg");

var break_points = viz.selectAll('g')
                      .data(arrangement)
                      .enter()
                      .append('g')
                      .classed('break_point',true);

break_points.selectAll('text')
  .data(function (d) {
    return d;
  })
  .enter()
  .append('text')
  .text(function(d) { return d; });





/*  
  bars
     .append('rect')
     .attr("x", function(d, i){
        return (viz_range/bp_scale+end_separation)*i;
     })
     .attr("y", 0)
     .attr("width",viz_range/bp_scale)
     .attr("height", 20)
     .attr("fill", 'rgba(0,0,200,0.5)');

  bars.append('text')
    .attr("x", function(d, i) { return (viz_range/bp_scale+end_separation)*i; })
    .attr("y", 30)
    .attr("dy", ".35em")
    .text(function(d) { return d[0] + ": " + d[1]; });
*/

console.log(arrangement);



var rows = d3.select("#breakend-list tbody").selectAll('tr')
  .data(breakends)
  .enter()
  .append('tr')
  .on("click", function(d, i) {
    selected_breakend = d;
    get_genes();
    $('#breakend-list').find('tr.highlight').removeClass('highlight');
    $(this).addClass('highlight');
  });
d3.select("#breakend-list tbody").select('tr').classed('highlight', true);

var cells = rows.selectAll("td")
  .data(function(row) {
    return columns.map(function(column) {
      var cell = row[column];
      if (typeof cell == 'object') {
        return Object.keys(cell);
      }
      return cell;
    })
  })
  .enter()
  .append("td")
  .text(function(d) {
    return d;
  });

var gene_list = d3.select("#gene-list");
var gene_list_heading = gene_list.append("h4");

var last_url;
var get_genes = function() {
  var chrom_id = selected_breakend['CHROM'];
  var position = selected_breakend['POS'];
  var start = position - gene_range;
  var end = position + gene_range;
  var url = '/genes/' + chrom_id + ':' + start + '-' + end;
  
  if (url !== last_url) {
    $.getJSON(url, function(json){
        response = json;
        console.log(response);
        gene_list
          .selectAll("li")
          .remove();

        var heading_msg;
        if (response && response.length) {
          gene_list
            .selectAll("li")
            .data(response)
            .enter()
            .append("li")
            .append("a")
            .text(function(d) {
              return d['external_name'];
            })
            .attr("href", function(d) {
              // Need more flexible link
              return 'http://www.genecards.org/cgi-bin/carddisp.pl?gene=' + d['id'];
            });

          heading_msg = "Genes within " + gene_range + "bp of selected breakend:";
        } else {
          heading_msg = "No genes were found within " + gene_range + "bp of this breakend.";
        }
        gene_list_heading.text(heading_msg);
        last_url = url;
    });
  }
};
get_genes();
    
</script>
{% endblock %}